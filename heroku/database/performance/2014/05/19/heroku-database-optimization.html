<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta content="@zlu" property="twitter:site"/>
  <meta content="summary" property="twitter:card"/>
  <meta content="Heroku Database Optimization" property="twitter:title"/>
  <meta content="Most of us web devs rely on NewRelic to identify slow database queries.  Heroku offers a useful, free and little-known command-line tool, heroku-pg-extra that provides great insight as well.
" property="twitter:description"/>
  <meta content="@zlu" property="twitter:creator"/>
  <meta content="www.zlu.me" property="twitter:domain"/>
  <meta content="http://blog.zlu.me/" property="twitter:image:src"/>

  <title>Heroku Database Optimization</title>

  <link rel="author" href="https://plus.google.com/+Zhaolu"/>

  <!-- syntax highlighting CSS -->
  <link rel="stylesheet" href="/css/syntax.css">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/zhaolu.css">

  <link href='http://fonts.googleapis.com/css?family=Trykker' rel='stylesheet' type='text/css'>

  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">

  <!-- Optional theme -->
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">

  <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>

  <!-- Latest compiled and minified JavaScript -->
  <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-7031506-4', 'zlu.me');
    ga('send', 'pageview');

  </script>
</head>
<body>

<div class="container">
  <div class="row">
    <div class="col-md-4">
      <div class="header">
        <h1 class="title"><a href="/">blog@zlu</a></h1>
        <a class="extra" href="/about">ABOUT</a>
      </div>

      
      <div style="margin-bottom: 10px;">
          <a href="/refactor/2015/12/20/on-refactor.html">On Refactor</a><br>
          <span>12-20-2015</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/gcc/ruby/yosemite/2014/08/28/yosemite-gcc-woe.html">Yosemite GCC Woe</a><br>
          <span>08-28-2014</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/git/2014/07/11/git-bisect.html">Git Bisect #FTW</a><br>
          <span>07-11-2014</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/git/2014/05/28/git-grep.html">Git Grep</a><br>
          <span>05-28-2014</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/git/2014/05/27/git-tip.html">Git Tip</a><br>
          <span>05-27-2014</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/yoga/2014/05/26/an-unbiased-yogic-guide-to-san-francisco.html">An Unbiased Yogic Guide to San Francisco</a><br>
          <span>05-26-2014</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/beijing/photo/2014/05/20/aunt-at-prince-gong-mansion.html">Aunt At Prince Gong's Mansion</a><br>
          <span>05-20-2014</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/heroku/database/performance/2014/05/19/heroku-database-optimization.html">Heroku Database Optimization</a><br>
          <span>05-19-2014</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/hiking/photo/2014/04/25/hike-at-wunderlich-park.html">Hike At Wunderlich Park</a><br>
          <span>04-25-2014</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/update/2013/11/01/site-updates.html">Site Updates</a><br>
          <span>11-01-2013</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/update/2013/09/29/site-updates.html">Site Updates</a><br>
          <span>09-29-2013</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/rails/cms/2013/09/27/quicksurveyofrailscms.html">Quick Survey Of Rails CMS</a><br>
          <span>09-27-2013</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/jekyll/github/plugin/2013/09/18/never-ending-journey-on-the-perfect-blogging-setup.html">The Never Ending Journey On The Perfect Blogging Setup</a><br>
          <span>09-18-2013</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/ruby/system%20call/security/2013/06/03/system-calls-in-ruby.html">System Calls In Ruby</a><br>
          <span>06-03-2013</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/rails/ruby/2013/05/29/initialization-is-an-interesting-thing.html">Initialization Is An Interesting Thing</a><br>
          <span>05-29-2013</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/shell/bash/2013/05/27/lost-shell-commands.html">Lost Shell Commands?</a><br>
          <span>05-27-2013</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/database/upgrade/sharedmemory/2013/02/04/postgres-gotchas.html">Postgres Gotchas</a><br>
          <span>02-04-2013</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/ruby/rvm/2012/11/10/housekeeping-rvm.html">Housekeeping RVM</a><br>
          <span>11-10-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/ruby/system/2012/11/08/what-happened-to-fd-3-and-4-in-mri.html">What Happened to FD 3 and 4 in MRI</a><br>
          <span>11-08-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/deployment/apache/capistrano/2012/11/07/rolling-deployment.html">Rolling Deployment</a><br>
          <span>11-07-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/social/2012/11/01/encourage-social-sharing-in-china.html">Encouraging Social Sharing in China</a><br>
          <span>11-01-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/rails/2012/10/29/install-and-create-rails-4-dot-0-app.html">Install and Create Rails 4.0 App</a><br>
          <span>10-29-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/mongodb/activerecord/sql/2012/10/16/a-small-difference-between-mongoid-and-activerecord-query-interface.html">A Small Difference Between Mongoid and ActiveRecord Query Interface</a><br>
          <span>10-16-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/ruby/rails/gem/rvm/2012/10/16/segmentation-fault-with-rails-and-json.html">Segmentation fault with Rails and JSON</a><br>
          <span>10-16-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/dns/censorship/2012/08/30/accessing-facebook-in-vietnam.html">Accessing Facebook in Vietnam</a><br>
          <span>08-30-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/ruby/bash/gem/2012/07/31/uninstall-multiple-versions-of-multiple-ruby-gem.html">Uninstall Multiple Versions of Multiple Ruby Gems</a><br>
          <span>07-31-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/2012/07/19/pretty-print-json-in-command-line.html">Pretty Print JSON in Command Line</a><br>
          <span>07-19-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/mocking/rails/rspec/carrierwave/fog/s3/2012/07/17/testing-carrierwave-with-fog.html">Testing Carrierwave with Fog for Amazon S3</a><br>
          <span>07-17-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/emacs/2012/05/18/my-current-emacs.html">My Current Emacs</a><br>
          <span>05-18-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/bdd/agile/2012/05/13/tdd-by-jim-weirich.html">TDD by Jim Weirich</a><br>
          <span>05-13-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/wireshark/os%20x/mountain%20lion/2012/02/28/running-wireshark-on-mountain-lion.html">Running Wireshark on Mountain Lion</a><br>
          <span>02-28-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/ruby/os%20x/gem/mountain%20lion/2012/02/21/install-native-ruby-gem-in-mountain-lion-preview.html">Install Native Ruby Gem in Mountain Lion Preview</a><br>
          <span>02-21-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/tools/2012/02/14/rubymine-and-pivotaltracker-integration.html">RubyMine and PivotalTracker Integration</a><br>
          <span>02-14-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/ruby/2012/02/12/a-couple-things-to-watch-out-for-using-privatepub.html">A Couple Things to Watch Out For Using PrivatePub</a><br>
          <span>02-12-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/rspec/tdd/2012/02/12/rspec-arbitrary-handling-of-arguments.html">RSpec Arbitrary Handling of Arguments</a><br>
          <span>02-12-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/agile/2012/01/30/on-agile.html">On Agile</a><br>
          <span>01-30-2012</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/git/2011/11/01/git-auto-complete.html">Git auto complete</a><br>
          <span>11-01-2011</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/android,/test/2009/04/14/running-apidemos-tests-in-android-sdk-1.5pre.html">Running APIDemos Tests in Android SDK 1.5pre</a><br>
          <span>04-14-2009</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/ubuntu,/mac/2008/09/04/dualboot-ubuntu-on-macbook.html">Dualboot Ubuntu on Macbook</a><br>
          <span>09-04-2008</span>
      </div>
      
      <div style="margin-bottom: 10px;">
          <a href="/java/swing/visualization/1999/06/01/vizard.html">Vizard</a><br>
          <span>06-01-1999</span>
      </div>
      
    </div>
    <div class="col-md-8">
      <h2>Heroku Database Optimization</h2>
<p class="meta">05-19-2014</p>

Filed under: heroku, database, performance

<p></p>
<p></p>
<p></p>
<p>Most of us web devs rely on NewRelic to identify slow database queries.  Heroku offers a useful, free and little-known command-line tool, <a href="https://github.com/heroku/heroku-pg-extras">heroku-pg-extra</a> that provides great insight as well.</p>

<p>Once installed, run <code>heroku pg:outliers</code>, which shows the top 10 slow queries.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">                   qry                   |    exec_time    | prop_exec_time |  ncalls   | sync_io_time 
-----------------------------------------+-----------------+----------------+-----------+--------------
 SELECT  &quot;teacher_tweets&quot;.* FROM &quot;teac.. | 00:08:11.793401 | 30.5%          | 3,485,358 | 00:00:00
 SELECT &quot;lessons&quot;.* FROM &quot;lessons&quot;  WH.. | 00:07:06.119699 | 26.4%          | 64,543    | 00:00:00
 SELECT &quot;teachers&quot;.* FROM &quot;teachers&quot; I.. | 00:02:31.94909  | 9.4%           | 129,286   | 00:00:00
 SELECT COUNT(*) FROM &quot;workouts&quot;  WHER.. | 00:01:11.026701 | 4.4%           | 5,292,598 | 00:00:00
 SELECT  &quot;teachers&quot;.* FROM &quot;teachers&quot; .. | 00:00:55.749109 | 3.5%           | 1,735,350 | 00:00:00
 SELECT  &quot;studios&quot;.* FROM &quot;studios&quot;  W.. | 00:00:49.19646  | 3.0%           | 1,293,179 | 00:00:00
 SELECT &quot;lessons&quot;.* FROM &quot;lessons&quot;  WH.. | 00:00:45.412566 | 2.8%           | 14,166    | 00:00:00
 SELECT &quot;lessons&quot;.* FROM &quot;lessons&quot;  WH.. | 00:00:37.907575 | 2.3%           | 14,166    | 00:00:00
 SELECT &quot;retreats&quot;.* FROM &quot;retreats&quot;  .. | 00:00:30.425801 | 1.9%           | 64,556    | 00:00:00
 SELECT  &quot;teacher_images&quot;.* FROM &quot;teac.. | 00:00:23.229008 | 1.4%           | 1,116,421 | 00:00:00
(10 rows)
</code></pre></div>
<ul>
<li><strong>exec_time</strong> is the execution time of a query in hh:mm:ss.ms</li>
<li><strong>ncalls</strong> is number of calls for this query</li>
<li><strong>sync<strong>io</strong>time</strong> is the synchronous wait time</li>
</ul>

<p>If you want to see the entire query without truncation, run this instead:</p>

<p><code>heroku pg:outliers notruncate</code></p>
<div class="highlight"><pre><code class="language-text" data-lang="text">                   qry                                                                                                                        |    exec_time    | prop_exec_time |  ncalls   | sync_io_time 
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+----------------+-----------+--------------
 SELECT  &quot;teacher_tweets&quot;.* FROM &quot;teacher_tweets&quot;  WHERE &quot;teacher_tweets&quot;.&quot;teacher_id&quot; = $1  ORDER BY created_at DESC LIMIT ?                                                                                                                     | 00:08:11.809985 | 30.5%          | 3,485,466 | 00:00:00
 SELECT &quot;lessons&quot;.* FROM &quot;lessons&quot;  WHERE &quot;lessons&quot;.&quot;retired&quot; = ? AND &quot;lessons&quot;.&quot;teacher_id&quot; IN (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)  ORDER BY &quot;lessons&quot;.starts_at ASC | 00:07:06.132324 | 26.4%          | 64,545    | 00:00:00
 SELECT &quot;teachers&quot;.* FROM &quot;teachers&quot; INNER JOIN &quot;teachers_users&quot; ON &quot;teachers&quot;.&quot;id&quot; = &quot;teachers_users&quot;.&quot;teacher_id&quot; WHERE &quot;teachers_users&quot;.&quot;user_id&quot; = $1                                                                                         | 00:02:31.954223 | 9.4%           | 129,290   | 00:00:00
 SELECT COUNT(*) FROM &quot;workouts&quot;  WHERE &quot;workouts&quot;.&quot;lesson_id&quot; = ? AND &quot;workouts&quot;.&quot;user_id&quot; = ?                                                                                                                                                   | 00:01:11.029121 | 4.4%           | 5,292,762 | 00:00:00
 SELECT  &quot;teachers&quot;.* FROM &quot;teachers&quot;  WHERE &quot;teachers&quot;.&quot;id&quot; = $1  ORDER BY &quot;teachers&quot;.&quot;id&quot; ASC LIMIT ?                                                                                                                                           | 00:00:55.750938 | 3.5%           | 1,735,404 | 00:00:00
 SELECT  &quot;studios&quot;.* FROM &quot;studios&quot;  WHERE &quot;studios&quot;.&quot;id&quot; = $1  ORDER BY &quot;studios&quot;.&quot;id&quot; ASC LIMIT ?                                                                                                                                               | 00:00:49.198205 | 3.0%           | 1,293,221 | 00:00:00
 SELECT &quot;lessons&quot;.* FROM &quot;lessons&quot;  WHERE &quot;lessons&quot;.&quot;teacher_id&quot; = $1 AND &quot;lessons&quot;.&quot;retired&quot; = ?  ORDER BY &quot;lessons&quot;.starts_at ASC                                                                                                               | 00:00:45.412566 | 2.8%           | 14,166    | 00:00:00
 SELECT &quot;lessons&quot;.* FROM &quot;lessons&quot;  WHERE &quot;lessons&quot;.&quot;teacher_id&quot; = $1 AND &quot;lessons&quot;.&quot;retired&quot; = ?                                                                                                                                                 | 00:00:37.907575 | 2.3%           | 14,166    | 00:00:00
 SELECT &quot;retreats&quot;.* FROM &quot;retreats&quot;  WHERE &quot;retreats&quot;.&quot;featured&quot; = ?                                                                                                                                                                             | 00:00:30.426673 | 1.9%           | 64,558    | 00:00:00
 SELECT  &quot;teacher_images&quot;.* FROM &quot;teacher_images&quot;  WHERE &quot;teacher_images&quot;.&quot;teacher_id&quot; = $1 AND &quot;teacher_images&quot;.&quot;featured&quot; = ?  ORDER BY &quot;teacher_images&quot;.&quot;id&quot; ASC LIMIT ?                                                                       | 00:00:23.230178 | 1.4%           | 1,116,455 | 00:00:00
(10 rows)
</code></pre></div>
<p>Pick the top query you would like to optimize and remember measure, optimize, and measure again.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">zlu@zlu-mba:~/projects/foo (master)$ heroku pg:psql
psql (9.3.2, server 9.2.6)
SSL connection (cipher: DHE-RSA-AES256-SHA, bits: 256)
Type &quot;help&quot; for help.

foodb=&gt; EXPLAIN ANALYZE SELECT  &quot;teacher_tweets&quot;.* FROM &quot;teacher_tweets&quot;  WHERE &quot;teacher_tweets&quot;.&quot;teacher_id&quot; = 1  ORDER BY created_at DESC LIMIT 5;
                                                                            QUERY PLAN                                                                             
-------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit  (cost=30.04..30.05 rows=5 width=248) (actual time=0.141..0.141 rows=0 loops=1)
   -&gt;  Sort  (cost=30.04..30.05 rows=17 width=248) (actual time=0.135..0.135 rows=0 loops=1)
         Sort Key: created_at
         Sort Method: quicksort  Memory: 25kB
         -&gt;  Index Scan using index_teacher_tweets_on_teacher_id on teacher_tweets  (cost=0.00..29.99 rows=17 width=248) (actual time=0.057..0.057 rows=0 loops=1)
               Index Cond: (teacher_id = 1)
 Total runtime: 0.258 ms
(7 rows)
</code></pre></div>
<p><strong>Total runtime</strong> is what you want to cut down.</p>

<p>Add index of teacher<strong>id to teacher</strong>tweets table and measure again with &quot;EXPLAIN ANALYZE&quot;.</p>

<p>Once the optimization is deployed to the Heroku, run pg:outliners again to make sure optimization has happened and repeat the optimization process.</p>


    </div>
  </div>

  <div class="footer">
    <div style="margin-top: 10px; margin-bottom: 10px;">
<a href="https://twitter.com/zlu" target="_blank" class="unstyled">
  <span class="fa-stack fa-lg">
  <i class="fa fa-circle-o fa-stack-2x"></i>
  <i class="fa fa-twitter fa-stack-1x"></i>
  </span>
</a>
<a href="http://linkedin.com/in/zhaolu" target="_blank" class="unstyled">
    <span class="fa-stack fa-lg">
    <i class="fa fa-circle-o fa-stack-2x"></i>
    <i class="fa fa-linkedin fa-stack-1x"></i>
    </span>
</a>
</div>

  </div>
</div>

</body>
</html>
